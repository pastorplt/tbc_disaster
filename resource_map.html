<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>TBC Resource Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="/assets/favicon.ico" type="image/x-icon" />
  <link rel="shortcut icon" href="/assets/favicon.ico" type="image/x-icon" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />

  <style>
    html, body { height: 100%; margin: 0; }
    #map { height: calc(100% - 60px); }

    /* Title chip */
    .map-title {
      position: absolute; top: 70px; left: 50%; transform: translateX(-50%);
      z-index: 1000;
      font: 40px/1.2 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      font-weight: 800; color: #111; text-align: center;
      background: rgba(255,255,255,0.9);
      padding: 14px 25px; border-radius: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      pointer-events: none;
    }

    .leaflet-interactive { cursor: pointer; }

    /* Legend / Filters */
    .legend-panel {
      position: absolute;
      top: 70px; left: 10px;
      width: 300px; max-height: calc(100% - 90px);
      overflow-y: auto;
      z-index: 1000;
      background: rgba(255,255,255,0.95);
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      box-shadow: 0 4px 16px rgba(0,0,0,.12);
      padding: 10px;
      font: 13px/1.35 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      -webkit-overflow-scrolling: touch; overscroll-behavior: contain; touch-action: pan-y;
    }
    .legend-panel.closed { display: none; }

    .legend-header { display: none; }
    .legend-title { font-weight: 700; font-size: 14px; margin: 4px 0 8px; color: #111; }

    /* Dataset Selector */
    .dataset-select-container { margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid #e5e7eb; }
    .dataset-select-label { display: block; font-weight: 600; margin-bottom: 4px; font-size: 12px; color: #4b5563; }
    .form-select {
      width: 100%; padding: 8px; border-radius: 8px; border: 1px solid #d1d5db;
      font-size: 14px; background: #fff; cursor: pointer;
    }

    details { margin-bottom: 8px; border-radius: 8px; background: #f8fafc; border: 1px solid #e5e7eb; padding: 6px 8px; }
    details[open] { background: #eef2ff; }
    summary { list-style: none; cursor: pointer; display: flex; align-items: center; justify-content: space-between; gap: 8px; padding: 6px 4px; font-weight: 600; }
    summary::-webkit-details-marker { display: none; }
    .chev { transition: transform .2s ease; }
    details[open] .chev { transform: rotate(90deg); }

    .tag-list {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 6px;
      margin-top: 8px;
    }

    .tag-pill { display: inline-flex; align-items: center; gap: 8px; border: 1px solid #e3e6ef; border-radius: 999px; padding: 6px 10px; background: #fff; font-size: 13px; user-select: none; cursor: pointer; }
    .tag-pill input { cursor: pointer; }

    .panel-actions { display: flex; gap: 8px; padding-top: 8px; margin-top: 8px; border-top: 1px solid #e5e7eb; }
    .btn { border: 1px solid #d9deea; background: #fff; padding: 8px 12px; border-radius: 10px; font-size: 13px; cursor: pointer; }
    .btn-primary { border-color: #3b82f6; background: #3b82f6; color: #fff; }

    /* Popup Styling */
    .popup { font: 13px/1.35 system-ui, -apple-system, Segoe UI, Roboto, sans-serif; min-width: 260px; max-width: 380px; color: #111; }
    .popup h3 { font-size: 16px; margin: 0 0 4px; font-weight: 800; color: #bf3426; }
    .popup-meta { font-size: 11px; color: #6b7280; margin-bottom: 8px; }
    .field-row { margin: 4px 0; word-break: break-word; }
    .field-row b { font-weight: 650; color: #374151; }
    .tag-strip { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 4px; }
    .chip { display: inline-block; padding: 3px 8px; border-radius: 999px; border: 1px solid #e1e5ee; background: #f8fafc; font-size: 12px; }
    .popup hr { border:0; border-top:1px solid #e9ecef; margin:8px 0; }

    /* Show toggle on ALL viewports */
    .legend-toggle {
      display: inline-flex; align-items: center; justify-content: center;
      position: fixed; left: 12px; bottom: 12px; z-index: 1001;
      background: #111; color: #fff; border: 0;
      border-radius: 999px; padding: 10px 14px; font: 14px/1 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      box-shadow: 0 6px 18px rgba(0,0,0,.2);
    }
    .legend-toggle:active { transform: translateY(1px); }

    /* Mobile */
    @media (max-width: 767.98px) {
      .tag-list { grid-template-columns: 1fr; }
      .map-title { font-size: 22px; padding: 10px 16px; border-radius: 14px; }
      .legend-panel {
        position: fixed; top: 0; bottom: 0; left: 0; right: auto;
        width: 50vw; max-width: none; height: 100vh;
        border-radius: 0 12px 12px 0; padding: 8px 10px 12px;
        transform: translateX(-100%); transition: transform 220ms ease;
        border-left: 0; border-right: 1px solid #e5e7eb;
        box-shadow: 0 4px 16px rgba(0,0,0,.12);
        background: rgba(255,255,255,0.98);
        -webkit-overflow-scrolling: touch; overscroll-behavior: contain; touch-action: pan-y;
      }
      .legend-panel.open { transform: translateX(0); }

      .legend-header {
        display: flex; align-items: center; justify-content: space-between;
        gap: 8px; padding: 6px 2px 8px; position: sticky; top: 0;
        background: rgba(255,255,255,0.98); z-index: 2;
      }
      .legend-grabber { width: 40px; height: 4px; border-radius: 2px; background: #cbd5e1; margin: 4px auto 8px auto; }
      .legend-title { margin: 0 0 8px; }
      .legend-close-btn { border: none; background: #f3f4f6; color: #111; border-radius: 8px; padding: 6px 10px; font-size: 12px; cursor: pointer; }
      .legend-close-btn:active { transform: translateY(1px); }

      .desktop-only { display: none; }
      .leaflet-control-zoom { display: none !important; }
    }

    .leaflet-control-layers .basemap-heading,
    .leaflet-control-layers .overlays-heading { font-weight: 600; margin-bottom: 4px; display: block; }
  
    /* Chip color overrides */
    .tag-pill, .chip {
      --chip-bg: #f8fafc;
      --chip-border: #e1e5ee;
      --chip-text: #111;
      background: var(--chip-bg);
      border: 1px solid var(--chip-border);
      color: var(--chip-text);
    }
  </style>
</head>
<body>
  <div id="navbar-include"></div>
  <script src="include-nav.js"></script>

  <div id="map">
    <div class="map-title">TBC Resource Map</div>

    <button id="legendToggle" class="legend-toggle" type="button" aria-expanded="false" aria-controls="legendPanel">
      Filters
    </button>

    <aside class="legend-panel" id="legendPanel" aria-label="Filters">
      <div class="legend-header">
        <div class="legend-grabber" aria-hidden="true"></div>
        <div class="legend-title">Filters</div>
        <button class="legend-close-btn" type="button" id="legendClose">Close</button>
      </div>
      
      <div class="dataset-select-container">
        <label for="datasetSelect" class="dataset-select-label">Data Source</label>
        <select id="datasetSelect" class="form-select">
          <option value="resource">Resource Data</option>
          <option value="sonoma">Sonoma Disaster Data</option>
        </select>
      </div>

      <div class="legend-title desktop-only">Filters</div>

      <details id="grp-regular"><summary><span>Regular Services</span><span class="chev">▶</span></summary><div class="tag-list" id="list-regular"></div></details>
      <details id="grp-disaster"><summary><span>Disaster Services</span><span class="chev">▶</span></summary><div class="tag-list" id="list-disaster"></div></details>
      <details id="grp-physical"><summary><span>Physical Resources</span><span class="chev">▶</span></summary><div class="tag-list" id="list-physical"></div></details>

      <div class="panel-actions">
        <button class="btn" id="clearFilters">Clear filters</button>
        <button class="btn btn-primary" id="applyFilters">Apply</button>
      </div>
    </aside>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script>
    /* =========================================================
       CONFIG & OVERRIDES
    ========================================================= */
    const DATASETS = {
      sonoma: {
        url: "https://api.tbc.city/disaster/org_points.geojson",
        label: "Sonoma Disaster Data"
      },
      resource: {
        url: "https://api.tbc.city/disaster/resource_data.geojson",
        label: "Resource Data"
      }
    };
    
    // Tag renames
    const TAG_LABEL_OVERRIDES = {
      regular: {
        "Faith based services, house of worship": "Worship",
        "family programs": "Family",
        "spirititual needs": "Spiritual",
        "Childrens programs": "Children",
        "Childrens": "Children",
        "Youth programs": "Youth",
        "Youth": "Youth",
        "School or Day Care": "School/Day",
        "Foster Care / support for families in crisis": "Foster care",
        "Foster Care / Support for families in crisis": "Foster care",
        "Food - prepared meals": "Meals (prep)",
        "Food - groceries distribution": "Groceries",
        "Our Facility is available to other FBO organizations offering community services": "Facility avail.",
        "Bilingual or multilingual support": "Bilingual",
        "Bilingual / Multilingual service": "Bilingual",
        "Public school support/partnership": "School partner",
        "Public School Support / Partnership": "School partner",
        "Disability services & support": "Disability",
        "Disability Services & Support": "Disability",
        "Senior support/services": "Seniors",
        "Senior support / services": "Seniors",
        "Addiction recovery": "Recovery",
        "Homeless services": "Homeless",
        "Transportation": "Transport",
        "Mental health services": "Mental health",
        "Mental Health services": "Mental health",
        "Small groups for life skills develepment": "Life skills"
      },
      disaster: {
        "Child Care": "Child care",
        "Child care for disaster survivors": "Child care",
        "Youth programming for disaster survivors": "Youth programs",
        "Disability services & support for disaster survivors": "Disability",
        "Food - prepared meals for disaster survivors": "Meals (prep)",
        "Food - groceries distribution for disaster survivors": "Groceries",
        "Senior support/services for disaster survivors": "Seniors",
        "Transportation for disaster survivors": "Transport",
        "Mental health services for disaster survivors": "Mental health",
        "Our Facility is available to other FBO organizations offering disaster recovery services": "Facility avail.",
        "Our Facility is available to other organizations offering disaster recovery services": "Facility avail.",
        "Bilingual or multilingual support for disaster survivors": "Bilingual",
        "Resource Assistance / Gift Cards to disaster survivors": "Gift cards",
        "Clothing and Supplies for disaster survivors": "Clothing/supplies"
      },
      physical: {
        "Food or Meals for disaster survivors": "Meals",
        "Clothing and Supplies for disaster survivors": "Clothing/supplies",
        "Donations Management: e.g. Distribution of Clothes": "Donations mgmt",
        "Donations Management - Distribution of Clothes / Food / Water": "Donations mgmt",
        "etc. from our facility": "etc",
        "Volunteers for disaster response": "Volunteers",
        "Resource Assistance/Gift Cards to disaster survivors": "Gift cards",
        "Phone Support": "Phone support",
        "Cooling location": "Cooling",
        "Warming location": "Warming",
        "Sleeping area": "Sleeping",
        "Public Restrooms": "Restrooms",
        "Device Charging Stations": "Charging",
        "Kitchen use": "Kitchen",
        "Refrigeration": "Fridge",
        "Shelter": "Shelter",
        "Showers": "Showers",
        "Generator(s)": "Generator",
        "Vehicle: Van or Bus": "Van/Bus",
        "Our facility is available to other organizations offering community services": "Facility avail."
      }
    };

    // =========================================================
    // MAP INIT
    // =========================================================
    const esriGray = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Light_Gray_Base/MapServer/tile/{z}/{y}/{x}', { maxZoom: 20, attribution: 'Tiles &copy; Esri' });
    const cartoPositron = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { maxZoom: 20, subdomains: 'abcd', attribution: '&copy; OpenStreetMap contributors &copy; CARTO' });
    const esriWorldStreet = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}', { maxZoom: 20, attribution: 'Tiles &copy; Esri' });
    const esriTopo = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}', { maxZoom: 20, attribution: 'Tiles &copy; Esri' });

    const map = L.map('map', {
      center: [37.8, -122.3],
      zoom: 9,
      layers: [esriGray],
      preferCanvas: true,
      zoomControl: false 
    });
    L.control.zoom({ position: 'bottomright' }).addTo(map);

    const baseMaps = { 'Light': esriGray, 'Medium': cartoPositron, 'Street': esriWorldStreet, 'Topo': esriTopo };
    const layerControl = L.control.layers(baseMaps, null, { position: 'topright', collapsed: false }).addTo(map);
    const controlEl = layerControl.getContainer();
    const baseList = controlEl.querySelector('.leaflet-control-layers-base');
    if (baseList) { const h = document.createElement('div'); h.className = 'basemap-heading'; h.textContent = 'Basemap'; baseList.prepend(h); }

    // =========================================================
    // APP STATE
    // =========================================================
    let currentDatasetKey = 'sonoma';
    let allFeatures = [];
    let FIELDS = {}; 
    const markersLayer = L.layerGroup().addTo(map);

    // =========================================================
    // UTILITIES
    // =========================================================
    const el = (s) => document.querySelector(s);
    const normKey = (s) => String(s||'').toLowerCase().replace(/[\s._-]+/g,'').replace(/[^\p{L}\p{N}]/gu,'');
    
    function resolveFieldsFromSample(props) {
      const keys = Object.keys(props||{});
      const byNorm = new Map(keys.map(k => [normKey(k), k]));
      const pick = (...c) => { 
        for (const cand of c) { const k = normKey(cand); if (byNorm.has(k)) return byNorm.get(k); } 
        return null; 
      };

      return {
        name: pick("Organization Name","organization_name","Org Name"),
        website: pick("Website","website","URL"),
        type: pick("Organization Type","organization_type","Type"),
        address: pick("Full Address","full_address","Address"),
        
        // Standard Contact
        contact: pick("Disaster Contact","disaster_contact"),
        email: pick("Disaster Email","disaster_email"),
        phone: pick("Disaster Phone","disaster_phone"),
        
        // Resource Data
        org_leader: pick("org_leader"),
        org_leader_email: pick("org_leader_email"),
        org_leader_phone: pick("org_leader_phone"),
        compassion_leader: pick("compassion_leader"),
        compassion_leader_email: pick("compassion_leader_email"),
        compassion_leader_phone: pick("compassion_leader_phone"),
        org_size: pick("org_size", "Size"),
        other_resources: pick("other_resources", "Other Resources"),
        last_update: pick("last_update", "Timestamp"),

        regular: pick("Regular Services","regular_services"),
        disaster: pick("Disaster Services","disaster_services"),
        physical: pick("Physical Resources","physical_resources"),
      };
    }

    function normalizeTags(v) { if (!v && v !== 0) return []; if (Array.isArray(v)) return v.map(x => String(x).trim()).filter(Boolean); return String(v).split(/[,;|]/).map(s => s.trim()).filter(Boolean); }
    function uniqueSortedTags(features, fieldKey) { const set = new Set(); for (const f of features) normalizeTags(f.properties?.[fieldKey]).forEach(t => set.add(t)); return Array.from(set).sort((a,b)=>a.localeCompare(b)); }
    function labelFor(groupKey, tag) { const overrides = TAG_LABEL_OVERRIDES[groupKey] || {}; return overrides[tag] || tag; }

    function buildTagList(container, tags, groupKey) {
      container.innerHTML = "";
      tags.forEach(tag => {
        const id = `${groupKey}-${tag.replace(/\s+/g, "_")}`;
        const label = document.createElement('label');
        label.className = 'tag-pill';
        label.setAttribute('for', id);
        label.title = tag;
        const input = document.createElement('input');
        input.type = 'checkbox';
        input.id = id;
        input.value = tag;
        input.dataset.group = groupKey;
        const span = document.createElement('span');
        span.textContent = labelFor(groupKey, tag);
        const c = colorForTag(groupKey, tag);
        label.style.setProperty('--chip-bg', c.bg);
        label.style.setProperty('--chip-border', c.border);
        label.style.setProperty('--chip-text', c.text);
        label.appendChild(input);
        label.appendChild(span);
        container.appendChild(label);
      });
    }

    const PALETTE30 = ['#1f77b4','#ff7f0e','#2ca02c','#d62728','#9467bd','#8c564b','#e377c2','#7f7f7f','#bcbd22','#17becf','#393b79','#637939','#8c6d31','#843c39','#7b4173','#3182bd','#31a354','#756bb1','#636363','#e6550d','#9edae5','#c7c7c7','#bc80bd','#ffed6f','#a6cee3','#b2df8a','#fb9a99','#fdbf6f','#cab2d6','#6a3d9a'];
    function hashIndex(str, m){ let h=0; for(let i=0;i<str.length;i++) h=(h*31 + str.charCodeAt(i))|0; return Math.abs(h)%m; }
    function hexToRgba(hex, alpha) {
      const m = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
      if (!m) return `rgba(0,0,0,${alpha})`;
      const r = parseInt(m[1], 16), g = parseInt(m[2], 16), b = parseInt(m[3], 16);
      return `rgba(${r},${g},${b},${alpha})`;
    }
    function colorForTag(groupKey, tag) {
      const key = `${groupKey}|${tag}`;
      const base = PALETTE30[ hashIndex(key, PALETTE30.length) ];
      return { bg: hexToRgba(base, 0.15), border: base, text: "#111" };
    }
    function colorForFeature(props) { const key = `${props[FIELDS.name]||''}|${props[FIELDS.address]||''}`; return PALETTE30[ hashIndex(key, PALETTE30.length) ]; }

    // =========================================================
    // FORMATTING HELPERS
    // =========================================================

    // Phone: formats 14085551212 -> (408) 555-1212
    function formatUSPhone(str) {
      if (!str) return "";
      const cleaned = ('' + str).replace(/\D/g, '');
      // If starts with 1 and is 11 digits, strip the 1
      const num = (cleaned.length === 11 && cleaned[0] === '1') ? cleaned.substring(1) : cleaned;
      const match = num.match(/^(\d{3})(\d{3})(\d{4})$/);
      if (match) {
        return `(${match[1]}) ${match[2]}-${match[3]}`;
      }
      return str; // Return original if it doesn't match standard US length
    }

    function formatContactString(props, nameKey, emailKey, phoneKey) {
      const name = props[nameKey] || "";
      const email = props[emailKey] || "";
      let phone = props[phoneKey] || "";
      
      // Clean up phone if it exists
      if (phone) phone = formatUSPhone(phone);
      
      if (!name && !email && !phone) return null;
      
      const parts = [];
      if (name) parts.push(name);
      if (email) parts.push(email);
      if (phone) parts.push(phone);
      
      return parts.join(", ");
    }

    function cleanAddress(addr) {
      if (!addr) return "";
      // Removes surrounding quotes if they exist
      return addr.replace(/^"|"$/g, '');
    }

    function formatDate(val) {
      if (!val) return "";
      // Try to rely on the string first if it looks like MM/DD/YYYY or similar
      // If it's a raw ISO string (e.g. 2025-10-31T...), parse it.
      if (val.includes('T') && val.includes('Z')) {
         const d = new Date(val);
         if (!isNaN(d.getTime())) return d.toLocaleDateString();
      }
      // Otherwise, return the string as-is (e.g. "10/31/2025")
      return val;
    }

    // =========================================================
    // POPUP LOGIC
    // =========================================================
    function makePopup(props) {
      const name = props[FIELDS.name] || "(No name)";
      const website = props[FIELDS.website];
      const orgType = props[FIELDS.type];
      const address = cleanAddress(props[FIELDS.address]);
      
      const reg = normalizeTags(props[FIELDS.regular]);
      const dis = normalizeTags(props[FIELDS.disaster]);
      const phy = normalizeTags(props[FIELDS.physical]);

      const chipHtml = (arr, group) => arr.map(t => {
        const c = colorForTag(group, t);
        const short = labelFor(group, t);
        return '<span class="chip" title="' + t + '" style="--chip-bg:' + c.bg + ';--chip-border:' + c.border + ';--chip-text:' + c.text + '">' + short + '</span>';
      }).join(" ");

      let contactInfoHtml = "";
      let metaInfoHtml = "";

      if (currentDatasetKey === 'resource') {
        const orgLeader = formatContactString(props, FIELDS.org_leader, FIELDS.org_leader_email, FIELDS.org_leader_phone);
        const disasterContact = formatContactString(props, FIELDS.contact, FIELDS.email, FIELDS.phone);
        const compassionLeader = formatContactString(props, FIELDS.compassion_leader, FIELDS.compassion_leader_email, FIELDS.compassion_leader_phone);
        const size = props[FIELDS.org_size];
        const updateRaw = props[FIELDS.last_update];
        const update = formatDate(updateRaw);
        
        if (size) metaInfoHtml += `<span>Size: ${size}</span>`;
        if (update) metaInfoHtml += ` • <span>Updated: ${update}</span>`;
        
        if (orgLeader) contactInfoHtml += `<div class="field-row"><b>Org Leader:</b> ${orgLeader}</div>`;
        if (disasterContact) contactInfoHtml += `<div class="field-row"><b>Disaster Contact:</b> ${disasterContact}</div>`;
        if (compassionLeader) contactInfoHtml += `<div class="field-row"><b>Compassion Leader:</b> ${compassionLeader}</div>`;
        
      } else {
        const contact = props[FIELDS.contact];
        const email = props[FIELDS.email];
        let phone = props[FIELDS.phone];
        if (phone) phone = formatUSPhone(phone);
        
        if (contact) contactInfoHtml += `<div class="field-row"><b>Disaster Contact:</b> ${contact}</div>`;
        if (email) contactInfoHtml += `<div class="field-row"><b>Email:</b> <a href="mailto:${email}">${email}</a></div>`;
        if (phone) contactInfoHtml += `<div class="field-row"><b>Phone:</b> <a href="tel:${phone}">${phone}</a></div>`;
      }

      const otherRes = props[FIELDS.other_resources];

      return `
        <div class="popup">
          <h3>${name}</h3>
          ${metaInfoHtml ? `<div class="popup-meta">${metaInfoHtml}</div>` : ""}
          
          ${website ? `<div class="field-row"><b>Website:</b> <a href="${website.startsWith('http') ? website : 'https://'+website}" target="_blank" rel="noopener">${website}</a></div>` : ""}
          ${orgType ? `<div class="field-row"><b>Type:</b> ${orgType}</div>` : ""}
          ${address ? `<div class="field-row"><b>Address:</b> ${address}</div>` : ""}
          
          <hr style="opacity:0.5; margin:6px 0;">
          ${contactInfoHtml}
          <hr style="opacity:0.5; margin:6px 0;">

          ${reg.length ? `<div class="field-row"><b>Regular Services:</b><div class="tag-strip">${chipHtml(reg, 'regular')}</div></div>` : ""}
          ${dis.length ? `<hr/><div class="field-row"><b>Disaster Services:</b><div class="tag-strip">${chipHtml(dis, 'disaster')}</div></div>` : ""}
          ${phy.length ? `<hr/><div class="field-row"><b>Physical Resources:</b><div class="tag-strip">${chipHtml(phy, 'physical')}</div></div>` : ""}
          
          ${otherRes ? `<hr/><div class="field-row"><b>Other Resources:</b><div style="font-size:12px;margin-top:2px;">${otherRes}</div></div>` : ""}
        </div>`;
    }

    // =========================================================
    // RENDERING & FILTERING
    // =========================================================
    function drawMarkers(features) {
      markersLayer.clearLayers();
      const pts = [];
      features.forEach(f => {
        const [lng, lat] = f.geometry?.coordinates || [];
        if (typeof lat !== "number" || typeof lng !== "number") return;
        const props = f.properties || {};
        const color = colorForFeature(props);
        const m = L.circleMarker([lat, lng], { radius: 6, weight: 2, color, fillColor: color, opacity: 1, fillOpacity: 0.85 });
        m.bindPopup(makePopup(props));
        markersLayer.addLayer(m);
        pts.push([lat, lng]);
      });
      if (pts.length) map.fitBounds(L.latLngBounds(pts).pad(0.08));
    }

    function getSelected(groupKey) { return Array.from(document.querySelectorAll(`input[type="checkbox"][data-group="${groupKey}"]:checked`)).map(i => i.value); }
    
    function featureMatchesSelections(f, sel) {
      const p = f.properties || {};
      const reg = normalizeTags(p[FIELDS.regular]);
      const dis = normalizeTags(p[FIELDS.disaster]);
      const phy = normalizeTags(p[FIELDS.physical]);
      if (sel.regular.length && !sel.regular.some(t => reg.includes(t))) return false;
      if (sel.disaster.length && !sel.disaster.some(t => dis.includes(t))) return false;
      if (sel.physical.length && !sel.physical.some(t => phy.includes(t))) return false;
      return true;
    }

    function applyFilters() {
      const selections = { regular: getSelected("regular"), disaster: getSelected("disaster"), physical: getSelected("physical") };
      drawMarkers(allFeatures.filter(f => featureMatchesSelections(f, selections)));
      collapseAllSections();
    }
    function clearFilters() { document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false); applyFilters(); }
    function collapseAllSections() { document.querySelectorAll('#legendPanel details[open]').forEach(d => d.removeAttribute('open')); }

    // =========================================================
    // LOAD DATA
    // =========================================================
    function loadData(key) {
      const cfg = DATASETS[key];
      if (!cfg) return;
      
      currentDatasetKey = key;
      markersLayer.clearLayers();
      allFeatures = [];
      
      el("#list-regular").innerHTML = "Loading...";
      el("#list-disaster").innerHTML = "";
      el("#list-physical").innerHTML = "";

      fetch(cfg.url, { cache: 'no-cache' })
        .then(r => r.json())
        .then(data => {
          const features = Array.isArray(data?.features) ? data.features : [];
          allFeatures = features;
          if (!features.length) {
            el("#list-regular").innerHTML = "No data found.";
            return;
          }

          FIELDS = resolveFieldsFromSample(features[0]?.properties || {});
          
          const regTags = uniqueSortedTags(features, FIELDS.regular);
          const disTags = uniqueSortedTags(features, FIELDS.disaster);
          const phyTags = uniqueSortedTags(features, FIELDS.physical);
          
          buildTagList(el("#list-regular"), regTags, "regular");
          buildTagList(el("#list-disaster"), disTags, "disaster");
          buildTagList(el("#list-physical"), phyTags, "physical");

          drawMarkers(allFeatures);
        })
        .catch(err => { 
          console.error("Failed to load GeoJSON:", err); 
          el("#list-regular").textContent = "Failed to load data.";
        });
    }

    // Init
    const dsSelect = el("#datasetSelect");
    dsSelect.addEventListener("change", (e) => loadData(e.target.value));
    el("#applyFilters").addEventListener("click", applyFilters);
    el("#clearFilters").addEventListener("click", clearFilters);

    loadData('sonoma');

    // Legend interactions
    const legendPanel = document.getElementById('legendPanel');
    const legendToggle = document.getElementById('legendToggle');
    const legendClose = document.getElementById('legendClose');

    L.DomEvent.disableScrollPropagation(legendPanel);
    L.DomEvent.disableClickPropagation(legendPanel);

    function isMobile() { return window.matchMedia('(max-width: 767.98px)').matches; }

    let scrollLockY = 0;
    function lockScroll() { scrollLockY = window.scrollY || document.documentElement.scrollTop || 0; document.body.style.position='fixed'; document.body.style.top=`-${scrollLockY}px`; document.body.style.left='0'; document.body.style.right='0'; document.body.style.width='100%'; document.body.style.overflow='hidden'; document.documentElement.style.overflow='hidden'; }
    function unlockScroll() { document.body.style.position=''; document.body.style.top=''; document.body.style.left=''; document.body.style.right=''; document.body.style.width=''; document.body.style.overflow=''; document.documentElement.style.overflow=''; window.scrollTo(0, scrollLockY); }

    function openLegend() {
      if (isMobile()) { legendPanel.classList.add('open'); lockScroll(); }
      legendPanel.classList.remove('closed');
      if (legendToggle) legendToggle.setAttribute('aria-expanded', 'true');
    }
    function closeLegend() {
      if (isMobile()) { legendPanel.classList.remove('open'); unlockScroll(); }
      legendPanel.classList.add('closed');
      if (legendToggle) legendToggle.setAttribute('aria-expanded', 'false');
    }

    if (legendToggle) legendToggle.addEventListener('click', () => {
      const isHiddenDesktop = legendPanel.classList.contains('closed');
      const isOpenMobile = legendPanel.classList.contains('open');
      (isMobile() ? !isOpenMobile : isHiddenDesktop) ? openLegend() : closeLegend();
    });
    if (legendClose) legendClose.addEventListener('click', closeLegend);
  </script>
</body>
</html>
