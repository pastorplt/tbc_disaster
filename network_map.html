<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>TBC Networks Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Favicon -->
  <link rel="icon" href="/assets/favicon.ico" type="image/x-icon" />
  <link rel="shortcut icon" href="/assets/favicon.ico" type="image/x-icon" />

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
  <style>
    :root { --label-size: 12px; }
    html, body { height: 100%; margin: 0; }
    #map { height: calc(100% - 60px); }

    /* ===== Header / Nav ===== */
    header { background-color: #bf3426; color: #fff; }
    .nav { height: 60px; display: flex; align-items: center; gap: 16px; padding: 0 16px; max-width: 1100px; margin: 0 auto; }
    .nav .brand { display: flex; align-items: center; gap: 10px; text-decoration: none; color: #fff; font-weight: 800; letter-spacing: 0.3px; }
    .nav .brand img { height: 36px; width: auto; display: block; }
    .nav-links { display: flex; align-items: center; gap: 18px; margin-left: auto; }
    .nav-links a { color: #fff; text-decoration: none; font-weight: 700; padding: 6px 4px; border-radius: 4px; opacity: 0.9; }
    .nav-links a:hover { text-decoration: underline; opacity: 1; }
    .nav-links a.active { text-decoration: underline; opacity: 1; }
    .nav, .nav a, .nav .brand { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif !important; }

    /* Title */
    .map-title {
      position: absolute; top: 70px; left: 50%; transform: translateX(-50%);
      z-index: 1000;
      font: 40px/1.2 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      font-weight: 800; color: #111; text-align: center;
      background: rgba(255,255,255,0.9);
      padding: 14px 25px; border-radius: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      pointer-events: none;
    }

    .leaflet-interactive { cursor: pointer; }

    /* ================= Legend ================= */
    .legend-panel {
      position: absolute;
      top: 70px; left: 10px;
      width: 300px; max-height: calc(100% - 90px);
      overflow-y: auto;
      z-index: 1000;
      background: rgba(255,255,255,0.95);
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      box-shadow: 0 4px 16px rgba(0,0,0,.12);
      padding: 10px;
      font: 13px/1.35 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      -webkit-overflow-scrolling: touch;
      overscroll-behavior: contain;
      touch-action: pan-y;
    }
    /* Desktop hide/show support */
    .legend-panel.closed { display: none; }

    .legend-header { display: none; }
    /* Flush-right total badge */
    .legend-title {
      font-weight: 700; font-size: 14px; margin: 4px 0 8px; color: #111;
      display: flex; align-items: center; justify-content: space-between; gap: 8px;
      width: 100%;
    }
    .legend-title .county-count { margin-left: 8px; }

    .county-group { margin-bottom: 6px; border-radius: 8px; }
    .county-group summary {
      list-style: none; cursor: pointer;
      padding: 8px 10px; border-radius: 8px;
      display: flex; align-items: center; justify-content: space-between; gap: 8px;
      background: #f8fafc; border: 1px solid #e5e7eb; position: sticky; top: 0;
    }
    .county-name { font-weight: 600; color: #111; }
    .county-count { font-size: 12px; color: #374151; background: #e5e7eb; border-radius: 999px; padding: 2px 8px; }
    .county-group[open] summary { background: #eef2ff; }

    .legend-list { list-style: none; padding: 6px 0 0; margin: 0; position: relative; }
    .legend-item { display: flex; align-items: center; gap: 10px; padding: 6px 8px; border-radius: 8px; cursor: pointer; }
    .legend-item:hover { background: #f3f4f6; }
    .swatch { width: 16px; height: 16px; border-radius: 4px; border: 1px solid rgba(0,0,0,.15); flex: 0 0 16px; box-shadow: inset 0 0 0 1px rgba(255,255,255,.25); }
    .legend-name { color: #111; }

    .legend-popup {
      position: absolute; left: 8px; right: 8px; z-index: 5;
      background: #fff; color: #111; border: 1px solid #e5e7eb;
      border-radius: 10px; box-shadow: 0 4px 14px rgba(0,0,0,.12);
      padding: 10px 12px 12px;
    }
    .legend-popup .close { display: none; } /* removed close button */

    /* Show the toggle button on ALL viewports */
    .legend-toggle {
      display: inline-flex; align-items: center; justify-content: center;
      position: fixed; left: 12px; bottom: 12px; z-index: 1001;
      background: #111; color: #fff; border: 0;
      border-radius: 999px; padding: 10px 14px; font: 14px/1 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      box-shadow: 0 6px 18px rgba(0,0,0,.2);
    }
    .legend-toggle:active { transform: translateY(1px); }

    /* -------- Mobile (<768px) -------- */
    @media (max-width: 767.98px) {
      .map-title { font-size: 22px; padding: 10px 16px; border-radius: 14px; }
      .legend-panel {
        position: fixed; top: 0; bottom: 0; left: 0; right: auto;
        width: 50vw; max-width: none; height: 100vh;
        border-radius: 0 12px 12px 0; padding: 8px 10px 12px;
        transform: translateX(-100%); transition: transform 220ms ease;
        border-left: 0; border-right: 1px solid #e5e7eb;
        box-shadow: 0 4px 16px rgba(0,0,0,.12);
        background: rgba(255,255,255,0.98);
        -webkit-overflow-scrolling: touch; overscroll-behavior: contain; touch-action: pan-y;
      }
      .legend-panel.open { transform: translateX(0); }

      .legend-header {
        display: flex; align-items: center; justify-content: space-between;
        gap: 8px; padding: 6px 2px 8px; position: sticky; top: 0;
        background: rgba(255,255,255,0.98); z-index: 2;
      }
      .legend-grabber { width: 40px; height: 4px; border-radius: 2px; background: #cbd5e1; margin: 4px auto 8px auto; }
      .legend-title { margin: 0 0 8px; }

      .desktop-only { display: none; }

      /* Hide Leaflet +/- zoom on mobile */
      .leaflet-control-zoom { display: none !important; }
    }

    /* Shared popup content */
    .tip { font: 13px/1.35 system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    .tip .label { color:#666; }
    .tip-name { font-size: 15px; font-weight: 600; margin-bottom: 2px; color: #111; }

    .poly-label {
      background: transparent; border: 0; box-shadow: none;
      color: #1f2937;
      font: 12px/1.2 system-ui, -apple-system, Segoe UI, Roboto, sans-serif; /* desktop default */
      text-align: center; white-space: nowrap; line-height: 1.15;
      text-shadow: 0 1px 2px rgba(255,255,255,.85), 0 0 2px rgba(255,255,255,.9);
      pointer-events: none;
      font-size: var(--label-size, 12px);
    }

    .leaflet-tooltip.hover-tip {
      background: #fff; color: #111;
      border: 1px solid #e5e7eb; border-radius: 10px;
      box-shadow: 0 4px 14px rgba(0,0,0,.12);
      padding: 8px 10px;
    }
    .leaflet-tooltip.hover-tip:before { display: none; }

    .gallery { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 8px; margin-top: 8px; }
    .gallery a { display:block; border-radius:8px; overflow:hidden; box-shadow: 0 1px 4px rgba(0,0,0,.12); }
    .gallery img { display:block; width:100%; height:100%; object-fit: cover; aspect-ratio: 4 / 3; }
    hr { border:0; border-top:1px solid #e9ecef; margin:8px 0; }

    .leaflet-control-layers .basemap-heading,
    .leaflet-control-layers .overlays-heading { font-weight: 600; margin-bottom: 4px; display: block; }

    /* ===== Mobile info sheet (modal) ===== */
    .sheet{ position: fixed; inset:0; z-index:1002; display:none; }
    .sheet.open{ display:block; }
    .sheet-backdrop{ position:absolute; inset:0; background:rgba(0,0,0,.35); }
    .sheet-panel{ position:absolute; left:0; right:0; bottom:0; background:#fff; border-radius:16px 16px 0 0; box-shadow: 0 -6px 24px rgba(0,0,0,.25); max-height:85vh; overflow:auto; padding:16px; }
    .sheet-close{ position:absolute; top:8px; right:8px; border:0; background:#f3f4f6; border-radius:999px; width:32px; height:32px; font-size:18px; }
    .sheet .tip{ font-size:14px; }
    .sheet .tip-name{ font-size:18px; margin-bottom:4px; }
    .sheet .actions{ margin-top:10px; display:flex; gap:10px; flex-wrap:wrap; }
    .sheet .actions a{ color:#0a58ca; text-decoration:underline; font-weight:700; }
    @media (min-width: 768px){ .sheet{ display:none !important; } } /* only show on mobile */
    .leaflet-popup-content a, .leaflet-popup-content button{ pointer-events:auto; }
  </style>
</head>
<body>
  <div id="navbar-include"></div>
  <script src="include-nav.js"></script>

  <div id="map">
    <div class="map-title">TBC Networks</div>

    <!-- Toggle button on all viewports -->
    <button id="legendToggle" class="legend-toggle" type="button" aria-expanded="false" aria-controls="legendPanel">
      Legend
    </button>

    <aside class="legend-panel" id="legendPanel" aria-label="Networks legend">
      <div class="legend-header">
        <div class="legend-grabber" aria-hidden="true"></div>
        <div class="legend-title">Networks by County <span id="totalNetworksMobile" class="county-count">0</span></div>
      </div>
      <div class="legend-title desktop-only">Networks by County <span id="totalNetworksDesktop" class="county-count">0</span></div>
      <div id="legendGroups"></div>
    </aside>
  </div>

  <!-- Mobile info sheet (modal) -->
  <div id="infoSheet" class="sheet" aria-hidden="true">
    <div class="sheet-backdrop" data-close="1"></div>
    <div class="sheet-panel" role="dialog" aria-modal="true" aria-labelledby="sheetTitle">
      <button class="sheet-close" type="button" data-close="1" aria-label="Close">×</button>
      <div id="sheetContent"></div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script>
    // Map with custom zoom control placement (avoid legend overlap)
    const map = L.map('map', { center: [37.8, -122.3], zoom: 9, preferCanvas: true, zoomControl: false });
    L.control.zoom({ position: 'bottomright' }).addTo(map);

    // Basemaps
    const esriGray = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Light_Gray_Base/MapServer/tile/{z}/{y}/{x}', { maxZoom: 20, attribution: 'Tiles &copy; Esri' }).addTo(map);
    const cartoPositron = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { maxZoom: 20, subdomains: 'abcd', attribution: '&copy; OpenStreetMap contributors &copy; CARTO' });
    const esriWorldStreet = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}', { maxZoom: 20, attribution: 'Tiles &copy; Esri' });
    const esriTopo = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}', { maxZoom: 20, attribution: 'Tiles &copy; Esri' });
    const baseMaps = { 'Light': esriGray, 'Medium': cartoPositron, 'Street': esriWorldStreet, 'Topo': esriTopo };

    // Overlays
    const networksGroup = L.layerGroup().addTo(map);
    const countiesGroup = L.layerGroup().addTo(map);

    const layerControl = L.control.layers(baseMaps, { 'Networks': networksGroup, 'Counties': countiesGroup }, { position: 'topright', collapsed: false }).addTo(map);
    const controlEl = layerControl.getContainer();
    const baseList = controlEl.querySelector('.leaflet-control-layers-base');
    if (baseList) { const h = document.createElement('div'); h.className = 'basemap-heading'; h.textContent = 'Basemap'; baseList.prepend(h); }
    const overlayList = controlEl.querySelector('.leaflet-control-layers-overlays');
    if (overlayList) { const h = document.createElement('div'); h.className = 'overlays-heading'; h.textContent = 'Layers'; overlayList.prepend(h); }

    // Helpers
    const palette30 = ['#1f77b4','#ff7f0e','#2ca02c','#d62728','#9467bd','#8c564b','#e377c2','#7f7f7f','#bcbd22','#17becf','#393b79','#637939','#8c6d31','#843c39','#7b4173','#3182bd','#31a354','#756bb1','#636363','#e6550d','#9edae5','#c7c7c7','#bc80bd','#ffed6f','#a6cee3','#b2df8a','#fb9a99','#fdbf6f','#cab2d6','#6a3d9a'];
    function hashIndex(str, m) { let h = 0; for (let i=0;i<str.length;i++) h = (h*31 + str.charCodeAt(i))|0; return Math.abs(h)%m; }
    function colorForFeature(ft) { const p = ft.properties || {}; const key = String(p.id || p.name || JSON.stringify(ft.geometry) || Math.random()); return palette30[hashIndex(key, palette30.length)]; }
    function styleNetworks(ft) { return { color: '#333', weight: 1.5, fillColor: colorForFeature(ft), fillOpacity: 0.5 }; }
    function highlight(e){ e.target.setStyle({ weight: 3, color:'#000', fillOpacity: 0.7 }); }
    function resetHighlight(e){ networksGeoJson && networksGeoJson.resetStyle(e.target); }
    function cleanedName(name){ if (!name || typeof name !== 'string') return 'Unnamed'; return name.replace(/\bnetworks?\b/gi,'').replace(/\s+/g,' ').trim() || 'Unnamed'; }
    function multilineName(name){ return cleanedName(name).split(/\s+/).filter(Boolean).join('<br>'); }
    function allPhotos(props = []){ return [props.photo1,props.photo2,props.photo3,props.photo4,props.photo5,props.photo6].filter(u => typeof u === 'string' && u.trim()); }
    function renderGallery(photos){ if (!photos.length) return ''; const items = photos.map((p,i)=>'<a href="'+p+'" target="_blank" rel="noopener"><img src="'+p+'" alt="Photo '+(i+1)+'" loading="lazy" /></a>').join(''); return '<hr/><div class="gallery">'+items+'</div>'; }
    function churchesLine(rawName) {
      return '<div><a href="/org_map?network='+encodeURIComponent(rawName)+'" target="_blank" rel="noopener">Map of Network Churches</a></div>';
    }
    function infoCardHtml(props = {}){
      const rawName = (props.name && String(props.name).trim()) || 'Unnamed';
      const emailLine = props.contact_email ? '<div><span class="label">Email:</span> <a href="mailto:'+props.contact_email+'">'+props.contact_email+'</a></div>' : '';
      const photos = allPhotos(props);
      return '<div class="tip"><div class="tip-name">'+rawName+'</div><div><span class="label">Leaders:</span> '+(props.leaders ?? '—')+'</div>'+emailLine+churchesLine(rawName)+renderGallery(photos)+'</div>';
    }

    // Legend state & helpers
    const legendPanel = document.getElementById('legendPanel');
    const legendGroupsEl = document.getElementById('legendGroups');
    const legendToggle = document.getElementById('legendToggle');
    const totalDesktopEl = document.getElementById('totalNetworksDesktop');
    const totalMobileEl = document.getElementById('totalNetworksMobile');
    let legendPopupEl = null;
    let legendPopupAnchorEl = null;

    // ===== Mobile Info Sheet helpers =====
    const sheetEl = document.getElementById('infoSheet');
    const sheetContentEl = document.getElementById('sheetContent');

    function infoSheetHtml(props = {}){
      const rawName = (props.name && String(props.name).trim()) || 'Unnamed';
      const emailLine = props.contact_email ? '<div><span class="label">Email:</span> <a href="mailto:'+props.contact_email+'">'+props.contact_email+'</a></div>' : '';
      const photos = allPhotos(props);
      return '<div class="tip">'
        + '<div class="tip-name" id="sheetTitle">'+rawName+'</div>'
        + '<div><span class="label">Leaders:</span> '+(props.leaders ?? '—')+'</div>'
        + emailLine
        + churchesLine(rawName)
        + renderGallery(photos)
        + '</div>';
    }
    function openSheet(html){
      if (!sheetEl) return;
      sheetContentEl.innerHTML = html;
      sheetEl.classList.add('open');
      sheetEl.setAttribute('aria-hidden','false');
      lockScroll();
    }
    function closeSheet(){
      if (!sheetEl) return;
      sheetEl.classList.remove('open');
      sheetEl.setAttribute('aria-hidden','true');
      unlockScroll();
    }
    if (sheetEl) {
      sheetEl.addEventListener('click', (e) => {
        const t = e.target;
        if (t.matches('[data-close]')) { e.stopPropagation(); closeSheet(); }
      }, { passive:false });
    }

    function isMobile() { return window.matchMedia('(max-width: 767.98px)').matches; }

    function isTouch() { return window.matchMedia('(pointer: coarse)').matches; }

    L.DomEvent.disableScrollPropagation(legendPanel);
    L.DomEvent.disableClickPropagation(legendPanel);

    let scrollLockY = 0;
    function lockScroll() { scrollLockY = window.scrollY || document.documentElement.scrollTop || 0; document.body.style.position='fixed'; document.body.style.top=`-${scrollLockY}px`; document.body.style.left='0'; document.body.style.right='0'; document.body.style.width='100%'; document.body.style.overflow='hidden'; document.documentElement.style.overflow='hidden'; }
    function unlockScroll() { document.body.style.position=''; document.body.style.top=''; document.body.style.left=''; document.body.style.right=''; document.body.style.width=''; document.body.style.overflow=''; document.documentElement.style.overflow=''; window.scrollTo(0, scrollLockY); }

    function openLegend() {
      if (isMobile()) { legendPanel.classList.add('open'); lockScroll(); }
      legendPanel.classList.remove('closed');
      if (legendToggle) legendToggle.setAttribute('aria-expanded', 'true');
    }
    function closeLegend() {
      if (isMobile()) { legendPanel.classList.remove('open'); unlockScroll(); }
      legendPanel.classList.add('closed');
      if (legendToggle) legendToggle.setAttribute('aria-expanded', 'false');
    }
    if (legendToggle) legendToggle.addEventListener('click', () => {
      const isHiddenDesktop = legendPanel.classList.contains('closed');
      const isOpenMobile = legendPanel.classList.contains('open');
      (isMobile() ? !isOpenMobile : isHiddenDesktop) ? openLegend() : closeLegend();
    });

    function repositionLegendPopup() {
      if (!legendPopupEl || !legendPopupAnchorEl) return;
      const panelRect = legendPanel.getBoundingClientRect();
      const aRect = legendPopupAnchorEl.getBoundingClientRect();
      const relativeTop = (aRect.top - panelRect.top) + legendPanel.scrollTop + legendPopupAnchorEl.offsetHeight + 6;
      legendPopupEl.style.top = relativeTop + 'px';
    }
    legendPanel.addEventListener('scroll', repositionLegendPopup);
    window.addEventListener('resize', repositionLegendPopup);

    function showLegendPopup(anchorEl, html) {
      if (legendPopupEl) legendPopupEl.remove();
      const el = document.createElement('div');
      el.className = 'legend-popup';
      el.innerHTML = html; // no close button
      legendPanel.appendChild(el);

      const panelRect = legendPanel.getBoundingClientRect();
      const aRect = anchorEl.getBoundingClientRect();
      const relativeTop = (aRect.top - panelRect.top) + legendPanel.scrollTop + anchorEl.offsetHeight + 6;
      el.style.top = relativeTop + 'px';

      legendPopupEl = el;
      legendPopupAnchorEl = anchorEl;
      if (isMobile()) openLegend();
    }

    // Load Networks
    let networksGeoJson;
    fetch('https://api.tbc.city/networks/polygons.geojson', { cache: 'no-cache' })
      .then(res => res.json())
      .then(data => {
        const groups = new Map();

        networksGeoJson = L.geoJSON(data, {
          style: styleNetworks,
          onEachFeature: (feature, layer) => {
            // Labels over polygons use cleaned name
            layer.bindTooltip(multilineName(feature.properties?.name), { permanent: true, direction: 'center', className: 'poly-label', opacity: 1 });
            layer.on('mouseover', (e) => { if (isTouch()) return; 
              highlight(e);
              const tip = L.tooltip({ className: 'hover-tip', direction: 'top', opacity: 0.95, offset: [0,-8] })
                .setContent(infoCardHtml(feature.properties))
                .setLatLng(e.latlng);
              layer._hoverTip = tip; tip.addTo(map);
            });
            layer.on('mousemove', (e) => { if (isTouch()) return;  if (layer._hoverTip) layer._hoverTip.setLatLng(e.latlng); });
            layer.on('mouseout', (e) => { if (isTouch()) return; 
              resetHighlight(e);
              if (layer._hoverTip) { map.removeLayer(layer._hoverTip); layer._hoverTip = null; }
            });
            layer.on('click', () => {
              const props = feature.properties || {};
              if (isMobile()) {
                openSheet(infoSheetHtml(props));
              } else {
                layer.bindPopup(infoCardHtml(props), { maxWidth: 480, closeOnClick: false, autoClose: true }).openPopup();
              }
            });

            const props = feature.properties || {};
            const county = (props.County && String(props.County).trim()) || (props.county && String(props.county).trim()) || 'Unspecified';
            const nameClean = cleanedName(props.name || 'Unnamed');
            const item = { name: nameClean, color: colorForFeature(feature), props, layer };
            if (!groups.has(county)) groups.set(county, []);
            groups.get(county).push(item);
          }
        }).addTo(networksGroup);

        const b = networksGeoJson.getBounds();
        if (b.isValid()) map.fitBounds(b.pad(0.05));

        buildCountyLegend(groups);
        // Initial label sizing after layers are added
        updateLabelSizes();
      });

    function buildCountyLegend(groups) {
      const counties = Array.from(groups.keys()).sort((a, b) => {
        if (a === 'Unspecified' && b !== 'Unspecified') return 1;
        if (b === 'Unspecified' && a !== 'Unspecified') return -1;
        return a.localeCompare(b, undefined, { sensitivity: 'base' });
      });

      // Total networks count
      let total = 0;
      groups.forEach(arr => { total += arr.length; });
      if (totalDesktopEl) totalDesktopEl.textContent = total;
      if (totalMobileEl) totalMobileEl.textContent = total;

      const legendGroupsEl = document.getElementById('legendGroups');
      legendGroupsEl.innerHTML = '';
      counties.forEach((county) => {
        const items = groups.get(county).slice().sort((a, b) => a.name.localeCompare(b.name, undefined, { sensitivity: 'base' }));
        const details = document.createElement('details');
        details.className = 'county-group';

        const summary = document.createElement('summary');
        const nameEl = document.createElement('span'); nameEl.className = 'county-name'; nameEl.textContent = county;
        const countEl = document.createElement('span'); countEl.className = 'county-count'; countEl.textContent = items.length;
        summary.appendChild(nameEl); summary.appendChild(countEl);

        const ul = document.createElement('ul'); ul.className = 'legend-list';

        items.forEach((item) => {
          const li = document.createElement('li'); li.className = 'legend-item';
          const swatch = document.createElement('span'); swatch.className = 'swatch'; swatch.style.background = item.color;
          const label = document.createElement('span'); label.className = 'legend-name'; label.innerHTML = item.name;
          li.appendChild(swatch); li.appendChild(label); ul.appendChild(li);

          // Click -> pan/zoom/highlight, then open UI appropriate to device
          li.addEventListener('click', (e) => {
            e.stopPropagation();
            try {
              if (legendPopupEl) { legendPopupEl.remove(); legendPopupEl = null; legendPopupAnchorEl = null; }
              const b = item.layer.getBounds();
              if (b && b.isValid && b.isValid()) {
                map.fitBounds(b.pad(0.15), { animate: true });
                item.layer.setStyle({ weight: 3, color: '#000', fillOpacity: 0.7 });
                setTimeout(() => { networksGeoJson && networksGeoJson.resetStyle(item.layer); }, 1200);
                if (isMobile()) {
                  openSheet(infoSheetHtml(item.props));
                } else {
                  const center = b.getCenter();
                  item.layer.bindPopup(infoCardHtml(item.props), { maxWidth: 480, closeOnClick: false, autoClose: true });
                  item.layer.openPopup(center);
                  if (item.layer.bringToFront) item.layer.bringToFront();
                }
              }
            } catch (err) {
              console.error('Legend click action failed:', err);
              const html = infoSheetHtml(item.props);
              openSheet(html);
            }
          });
        });

        details.appendChild(summary);
        details.appendChild(ul);
        legendGroupsEl.appendChild(details);
        details.addEventListener('toggle', () => setTimeout(repositionLegendPopup, 0));
      });
    }

    // Counties layer
    function styleCounties(){ return { color:'#b59f3b', weight:1, fillColor:'#fff9c4', fillOpacity:0.5 }; }
    fetch('tbc_counties.geojson', { cache: 'no-cache' })
      .then(res => res.json())
      .then(data => {
        const counties = L.geoJSON(data, { style: styleCounties }).addTo(countiesGroup);
        const b = counties.getBounds();
        if (b.isValid()) {
          const current = map.getBounds();
          const union = current.isValid() ? current.extend(b) : b;
        }
      });

    // ===== Label responsiveness to zoom (mobile & desktop) =====
    function updateLabelSizes() {
      const z = map.getZoom();
      const mobile = isMobile();
      // Start smaller on both, scale with zoom; gentle ramp on desktop
      const base = mobile ? 10 : 10.5;
      const slope = mobile ? 1.0 : 1.1; // px per zoom step above 8
      let size = base + (z - 8) * slope;
      const min = mobile ? 9 : 10;
      const max = 22;
      if (size < min) size = min;
      if (size > max) size = max;
      // Single DOM write using CSS variable
      document.documentElement.style.setProperty('--label-size', size.toFixed(1) + 'px');
    }
    map.on('zoomend', updateLabelSizes);
    map.whenReady(updateLabelSizes);
    window.addEventListener('resize', updateLabelSizes);

    // Keep popup interactions from bubbling; desktop uses Leaflet popup only
    map.on('popupopen', (e) => {
      const el = e.popup && e.popup.getElement && e.popup.getElement();
      if (!el) return;
      try { L.DomEvent.disableClickPropagation(el); L.DomEvent.disableScrollPropagation(el); } catch {}
    });

  </script>
</body>
</html>
